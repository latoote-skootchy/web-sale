<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Sale Page</title>
  <style>
    *{box-sizing:border-box;font-family:sans-serif}
    body{margin:0}
    .navbar{display:flex;justify-content:space-between;align-items:center;background:#000;color:#fff;padding:1rem}
    .btn{border:none;border-radius:4px;padding:.45rem 1rem;font-size:.9rem;cursor:pointer}
    .btn-back{background:#666;color:#fff}
    .btn-save{background:#0f8d3e;color:#fff}
    .btn-preview{background:#007bff;color:#fff}
    main{padding:1.5rem;max-width:760px;margin:0 auto}
    label{display:block;margin-top:1rem;font-weight:600}
    input[type="text"]{width:100%;padding:.55rem .7rem;border:1px solid #ccc;border-radius:4px}
    #link-group{display:flex;gap:.5rem;align-items:center;margin-top:.4rem}
    #link-input{flex:1}
    .btn-generate{background:#6c757d;color:#fff}
    .btn-copy{background:#ffc107;color:#fff}
    #image-slots{display:grid;gap:1rem;margin-top:1rem;grid-template-columns:repeat(auto-fill,minmax(160px,1fr))}
    .slot{border:1px dashed #ccc;border-radius:6px;padding:.5rem;text-align:center;position:relative;min-height:210px}
    .slot img{width:100%;height:120px;object-fit:cover;border-radius:4px;display:none;margin-bottom:.3rem}
    .slot input[type="file"]{width:100%;margin-top:32px}
    .slot span.label{font-size:.85rem;color:#666;display:block;margin-top:.25rem}
    .link-btn,.del-btn{position:absolute;top:6px;border:none;color:#fff;border-radius:4px;padding:2px 6px;font-size:.7rem;cursor:pointer}
    .link-btn{left:6px;background:#007bff}
    .link-btn.has{background:#28a745}
    .del-btn{right:6px;background:#d90404}
    #pdpa-link-wrap{display:none;margin-top:.8rem}
    #pdpa-link{padding:.55rem .7rem;border:1px solid #ccc;border-radius:4px;width:100%;background:#e9ecef}
  </style>
</head>
<body>
  <nav class="navbar">
    <div>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Sale Page</div>
    <button class="btn btn-back" onclick="history.back()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
  </nav>
  <main>
    <form id="edit-form">
      <label for="name-input">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏à:</label>
      <input id="name-input" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠" required />
      <label>‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏à:</label>
      <div id="link-group">
        <input id="link-input" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠ SUB DOMAIN" />
        <button type="button" id="btn-generate" class="btn btn-generate">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
        <button type="button" id="btn-copy" class="btn btn-copy">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
      </div>
      <small>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á URL: <code id="url-preview">‚Äî</code></small>

      <label style="margin-top:1.5rem;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10¬†‡∏†‡∏≤‡∏û):</label>
      <div id="image-slots"></div>

      <label for="pixel-input">Facebook Pixel ID:</label>
      <input id="pixel-input" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123456789012345" />

      <hr style="margin:2rem 0 1rem">
      <h3>‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (PDPA)</h3>
      <label><input type="checkbox" id="pdpa-toggle"> ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</label>
      <div id="pdpa-link-wrap">
        <label style="margin-top:.8rem">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß:</label>
        <div style="display:flex;gap:.5rem;align-items:center;margin-top:.3rem">
          <input id="pdpa-link" type="text" readonly>
          <button type="button" id="pdpa-copy" class="btn btn-copy">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
        </div>
      </div>

      <div style="display:flex;gap:.5rem;margin-top:2rem">
        <button type="submit" class="btn btn-save">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button type="button" id="btn-preview" class="btn btn-preview">Preview</button>
      </div>
    </form>
  </main>

<script>
(() => {
  const MAX_IMAGES = 10;
  const BASE_DOMAIN = 'skootchy.xyz';

  const params = new URLSearchParams(location.search);
  const id = params.get('id') || Date.now().toString();
  const nameI = document.getElementById('name-input');
  const slugI = document.getElementById('link-input');
  const urlPrev = document.getElementById('url-preview');
  const slots = document.getElementById('image-slots');
  const pdpaT = document.getElementById('pdpa-toggle');
  const pdpaWrap = document.getElementById('pdpa-link-wrap');
  const pdpaI = document.getElementById('pdpa-link');
  const pixelFB =  document.getElementById('pixel-input');

  let item = { id, name: '', slug: '', images: Array(MAX_IMAGES).fill(''), links: Array(MAX_IMAGES).fill(''), policy: false };

  const slugify = str => str.toLowerCase().trim().replace(/[‡∏Ä-‡πø]/g, '').replace(/[^a-z0-9]+/g, '').substring(0, 40);
  const fullURL = s => `https://${s}.${BASE_DOMAIN}`;

  async function fetchItem() {
    const res = await fetch('/api/pages');
    const all = await res.json();
    const found = all.find(x => x.id === id);
    if (found) item = found;
  }

  async function init() {
    await fetchItem();
    nameI.value = item.name;
    slugI.value = item.slug;
    pixelFB.value = item.pixel || '';

    pdpaT.checked = item.policy;
    updateURL();
    buildSlots();
    togglePdpa();
  }

  function updateURL() {
    const s = slugI.value.trim();
    urlPrev.textContent = s ? fullURL(s) : '‚Äî';
    if (pdpaT.checked) pdpaI.value = s ? `${fullURL(s)}/policy` : '';
  }

  function togglePdpa() {
    pdpaWrap.style.display = pdpaT.checked ? 'block' : 'none';
    if (pdpaT.checked) updateURL();
  }

  document.getElementById('btn-generate').onclick = () => {
    slugI.value = slugify(nameI.value);
    updateURL();
  };

  slugI.oninput = updateURL;
  document.getElementById('btn-copy').onclick = () => navigator.clipboard.writeText(urlPrev.textContent);
  pdpaT.onchange = () => { item.policy = pdpaT.checked; togglePdpa(); };
  document.getElementById('pdpa-copy').onclick = () => navigator.clipboard.writeText(pdpaI.value);

  document.getElementById('edit-form').onsubmit = async e => {
    e.preventDefault();
    const ok = await validate();
    if (!ok) return;
    await persist();
    location.href = 'home.html';
  };

  document.getElementById('btn-preview').onclick = async () => {
    const ok = await validate();
    if (!ok) return;
    await persist();
    window.open(fullURL(slugI.value.trim().toLowerCase()), '_blank');
  };

  function buildSlots() {
    slots.innerHTML = '';
    for (let i = 0; i < MAX_IMAGES; i++) {
      const slot = document.createElement('div');
      slot.className = 'slot';
      const img = document.createElement('img');
      if (item.images[i]) {
        img.src = item.images[i];
        img.style.display = 'block';
      }
      const file = document.createElement('input');
      file.type = 'file';
      file.accept = 'image/*';

      const linkBtn = document.createElement('button');
      linkBtn.type = 'button';
      linkBtn.className = 'link-btn';
      linkBtn.textContent = '‡∏•‡∏¥‡∏á‡∏Å‡πå';
      if (item.links[i]) linkBtn.classList.add('has');

      const delBtn = document.createElement('button');
      delBtn.type = 'button';
      delBtn.className = 'del-btn';
      delBtn.textContent = '‡∏•‡∏ö';

      const lbl = document.createElement('span');
      lbl.className = 'label';
      lbl.textContent = `‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${i + 1}`;

      const EVENTS = {
        '‡∏ú‡∏π‡πâ‡∏™‡∏ô‡πÉ‡∏à (Lead)': 'Lead',
        '‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (ViewContent)': 'ViewContent',
        '‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß (Purchase)': 'Purchase',
        '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ (AddToCart)': 'AddToCart',
        '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Subscribe)': 'Subscribe'
      };

      const eventSelect = document.createElement('select');
      eventSelect.style.marginTop = '0.4rem';
      eventSelect.style.width = '100%';
      eventSelect.style.padding = '0.4rem';
      eventSelect.style.borderRadius = '4px';

      Object.entries(EVENTS).forEach(([label, value]) => {
        const opt = document.createElement('option');
        opt.value = value;               // ‚úÖ ‡∏à‡∏∞‡πÑ‡∏î‡πâ 'Lead', 'Purchase', ...
        opt.textContent = `üìå ${label}`; // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ó‡∏¢
        eventSelect.appendChild(opt);
      });

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      eventSelect.value = item.events?.[i] || 'Lead';

      eventSelect.onchange = () => {
        if (!Array.isArray(item.events)) item.events = Array(MAX_IMAGES).fill('');
        item.events[i] = eventSelect.value;
      };

      file.onchange = e => {
        if (!e.target.files.length) return;
        const reader = new FileReader();
        reader.onload = ev => {
          item.images[i] = ev.target.result;
          img.src = ev.target.result;
          img.style.display = 'block';
        };
        reader.readAsDataURL(e.target.files[0]);
      };

      linkBtn.onclick = () => {
        if (!item.images[i]) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå');
        const url = prompt('‡πÉ‡∏™‡πà URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ', item.links[i] || '');
        if (!url) return;
        item.links[i] = url.trim();
        linkBtn.classList.add('has');
      };

      delBtn.onclick = () => {
        if (!item.images[i]) return;
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
        item.images[i] = '';
        item.links[i] = '';
        img.style.display = 'none';
        file.value = '';
        linkBtn.classList.remove('has');
      };
      const eventLabel = document.createElement('span');
      eventLabel.textContent = 'üìå ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Facebook Pixel Event:';
      eventLabel.style.display = 'block';
      eventLabel.style.marginTop = '0.5rem';
      eventLabel.style.fontSize = '0.85rem';


      slot.append(linkBtn, delBtn, img, file, lbl, eventLabel, eventSelect);
      slots.appendChild(slot);
    }
  }

  async function validate() {
    const name = nameI.value.trim();
    const slug = slugI.value.trim();
    if (!name) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏à'), false;
    if (!slug) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å slug'), false;

    const res = await fetch('/api/pages');
    const all = await res.json();

    const dupName = all.some(p => p.name.trim().toLowerCase() === name.toLowerCase() && p.id !== id);
    const dupSlug = all.some(p => (p.slug || '') === slug && p.id !== id);

    if (dupName) return alert('‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏à‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß'), false;
    if (dupSlug) return alert('slug ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß'), false;

    return true;
  }

  async function persist() {
    item.id = id;
    item.name = nameI.value.trim();
    item.slug = slugI.value.trim();
    item.pixel = document.getElementById('pixel-input').value.trim();

    if (!Array.isArray(item.images)) item.images = Array(MAX_IMAGES).fill('');
    if (!Array.isArray(item.links)) item.links = Array(MAX_IMAGES).fill('');
    item.images.length = MAX_IMAGES;
    item.links.length = MAX_IMAGES;
    if (!Array.isArray(item.events)) item.events = Array(MAX_IMAGES).fill('Lead');
    item.events.length = MAX_IMAGES;

    await fetch('/api/pages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(item)
    });
  }

  init();
})();
</script>
</body>
</html>
